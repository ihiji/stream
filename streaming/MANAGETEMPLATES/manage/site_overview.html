        <script>
            var grid, dataStore, store;
            require([
                "dojo/ready",
                "dojox/grid/DataGrid",
                "dojo/store/Memory",
                "dojo/data/ObjectStore",
                "dojo/_base/xhr",
                "dijit/form/DropDownButton",
                "dijit/TooltipDialog",
                "dijit/form/TextBox",
                "dijit/form/Select",
                "dojox/form/CheckedMultiSelect",
                "dojo/dom",
                "dijit/form/DateTextBox",
                "dojo/date/locale",
                "dojo/domReady!"
            ], function(ready, DataGrid, Memory, ObjectStore,xhr, DropDownButton,
                        TooltipDialog, TextBox, Select, CheckedMultiSelect, dom){
                ready(function(){
                    var planDialog = new TooltipDialog({
                        href: '/manage/dealer/{{dealer_id}}/key/{{key_id}}/plan_list',
                        execute: function(){
                            //TODO - check to see if values have changed
                            //TODO - don't allow add-ons to free plan
                            xhr.post( {
                                url: '/manage/dealer/{{dealer_id}}/key/{{key_id}}/plan_change',
                                content: this.get('value'),
                                handleAs: 'json',
                                load: function(data){showMessage(data)},
                                error: function(data){showMessage(data)}
                            });
                        } 
                    });
                    var dateDialog = new TooltipDialog({
                        href: '/manage/dealer/{{dealer_id}}/key/{{key_id}}/plan_dates',
                        execute: function(){
                            //TODO - check to see if values have changed
                            //TODO - don't allow add-ons to free plan
                            xhr.post( {
                                url: '/manage/dealer/{{dealer_id}}/key/{{key_id}}/date_change',
                                content: this.get('value'),
                                handleAs: 'json',
                                load: function(data){showMessage(data)},
                                error: function(data){showMessage(data)}
                            });
                        } 
                    });

                    var planButton = new DropDownButton({
                        label: "Change Plan",
                        dropDown: planDialog
                    });
                    dom.byId("siteChangeButtonContainer{{site_id}}").appendChild(planButton.domNode);
                    var dateButton = new DropDownButton({
                        label: "Change Dates",
                        dropDown: dateDialog
                    });
                    dom.byId("siteChangeButtonContainer{{site_id}}").appendChild(dateButton.domNode);
                });    

                xhr.get({
                    url: "/manage/json/dealer/{{dealer_id}}/site/{{site_id}}/devices.json",
                    handleAs: "json"
                }).then(function(data){
                    store = new Memory({ data: data.items });
                    dataStore = new ObjectStore({ objectStore: store });
    
                    grid = new DataGrid({
                        store: dataStore,
                        selectable: true,
                        autoWidth: true,
                        autoHeight: '10',
                        rowSelector: 8,
                        sortInfo: 1,
                        query: { id: "*" },
                        structure: [
                            { name: "Name", field: "name", width: "250px" },
                            { name: "IP", field: "address", width: "100px" },
                            { name: "Hard State", field: "hardState", width: "100px" },
                            { name: "Soft State", field: "state", width: "100px" },
                            { name: "Check Time", field: "last_check_time", width: "150px" },
                            { name: "Details", field: "last_check_details", width: "300px" },
                            { name: "Not. Count", field: "notification_counter", width: "100px" },
                            { name: "Uninitialized", field: "uninitialized", width: "100px" },
                        ]
                    }, "grid{{site_id}}");
                    
                    // since we created this grid programmatically, call startup to render it
                    grid.startup();
                });
            });
        </script>
        <button onclick="dijit.byId('{{site_id}}').refresh();">Refresh Tab</button>
        <h1>{{name}}</h1>
        <h2>{{site_name}}</h2>
        <div class="infoWrapper">
            <div class="leftBox" id="key_details">
                <span style="font-weight:bold;"><h2 style="margin-top:.2em;">Key Details</h2></span>
                <table>
{% for key, value in key_details.items %}
                <tr>
                    <td style="font-weight:bold;">{{key}}:</td>
                    <td>{{value}}</td>
                </tr>
{% endfor %}
                </table>
            </div>
            <div class="rightBox" id="s_info" >
                <span style="font-weight:bold;"><h2 style="margin-top:.2em;">Last Request Details</h2></span>
                <table>    
{% for key, value in s_info.items %}
                    <tr>
                        <td style="font-weight:bold;">{{key}}:</td>
                        <td>{{value}}</td>
                    </tr>
{% endfor %}
                </table>
            </div>
        </div>
        <div id="siteChangeButtonContainer{{site_id}}"></div>
        <br/>
        <div id="grid{{site_id}}"></div>

