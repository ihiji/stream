        <script>
            var grid, dataStore, store;
            require([
                "dojox/grid/DataGrid",
                "dojo/store/Memory",
                "dojo/data/ObjectStore",
                "dojo/_base/xhr",
                "dojo/domReady!"
            ], function(DataGrid, Memory, ObjectStore,xhr){
                xhr.get({
                    url: "/manage/json/dealer/{{dealer_id}}/sites.json",
                    handleAs: "json"
                }).then(function(data){
                    store = new Memory({ data: data.items });
                    dataStore = new ObjectStore({ objectStore: store });
    
                    keyGrid = new DataGrid({
                        selectable: true,
                        autoWidth: true,
                        autoHeight: '10',
                        sortInfo: 1,
                        rowSelector: 8, 
                        store: dataStore,
                        query: { id: "*" },
                        structure: [
                            { name: "Key",             field: "key",               width: "250px" },
                            { name: "Site Name",       field: "site_name",         width: "250px" },
                            { name: "Model",           field: "model",             width: "100px" },
                            { name: "Plan Count",      field: "number_of_devices", width: "80px" },
                            { name: "Installed Count", field: "used_devices",      width: "80px" },
                            { name: "Plan Name",       field: "plan_name",         width: "80px" }, 
                            { name: "Add-On Name",     field: "add_on_name",       width: "80px" }, 
                            { name: "Renewal Date",    field: "end_date",          width: "100px" },
                        ]
                    }, "site_grid{{dealer_id}}");
                    
                    // since we created this grid programmatically, call startup to render it
                    keyGrid.startup();

                    keyGrid.on("RowDblClick", function(evt){
                        var idx = evt.rowIndex,
                            item = this.getItem(idx),
                            store = this.store;
                        var id = store.getValue(item,"site_id");
                        if (id === "None"){
                            id = store.getValue(item,"key_id");
                            key = store.getValue(item,"key");
                            var name = "{{name}}  - " + key;
                            addTab(name,id, "/manage/dealer/{{dealer_id}}/key/" + id + "/");
                        } else {
                           var name = "{{name}} - " + store.getValue(item,"site_name");
                           addTab(name,id, "/manage/dealer/{{dealer_id}}/site/" + id + "/");
                        }
                    }, true);
                });
            });
        </script>
        <script>
            var cgrid, cdataStore, cstore;
            require([   "dijit/form/Select",
                        "dojox/form/CheckedMultiSelect", 
                        "dijit/form/TextBox",
                        "dijit/form/ValidationTextBox",
            ]);
            require([
                "dojo/ready",
                "dojox/grid/DataGrid",
                "dojo/store/Memory",
                "dojo/data/ObjectStore",
                "dojo/_base/xhr",
                "dijit/form/DropDownButton",
                "dijit/TooltipDialog",
                "dojo/dom",
                "dojo/domReady!"
            ], function(ready, DataGrid, Memory, ObjectStore,xhr,
                        DropDownButton, TooltipDialog, dom ){
                ready(function(){
                    var keyDialog = new TooltipDialog({
                        href: '/manage/dealer/{{dealer_id}}/add_key',
                        execute: function(){
                            xhr.post({
                                url: '/manage/dealer/{{dealer_id}}/add_key',
                                content: this.get('value'),
                                handleAs: 'json',
                                load: function(data){showMessage(data);},
                                error: function(data){showMessage(data)}
                            });
                        },
                    });
                    keyDialog.watch('state', function(property, oval, nval){
                        if (nval == ""){
                            dijit.byId("addKeyButton").set('disabled', false);
                        } else {
                            dijit.byId("addKeyButton").set('disabled', true);
                        }
                    });

                    var addKeyButton = new DropDownButton({
                        label: "Add Key",
                        dropDown: keyDialog
                    });
                    dom.byId("dealerChangeButtonContainer{{dealer_id}}").appendChild(addKeyButton.domNode);
                });
                xhr.get({
                    url: "/manage/json/dealer/{{dealer_id}}/contacts.json",
                    handleAs: "json"
                }).then(function(data){
                    cstore = new Memory({ data: data.items });
                    cdataStore = new ObjectStore({ objectStore: cstore });
    
                    cgrid = new DataGrid({
                        selectable: true,
                        sortInfo: 1,
                        autoWidth: true,
                        autoHeight: '10',
                        rowSelector: 8,
                        store: cdataStore,
                        query: { id: "*" },
                        structure: [
                            { name: "Name", field: "name", width: "200px" },
                            { name: "Email", field: "email", width: "200px" },
                            { name: "Login Enabled", field: "login_enabled", width: "100px" },
                            { name: "Primary", field: "primary", width: "100px" },
                        ]
                    }, "contact_grid{{dealer_id}}");
                    
                    // since we created this grid programmatically, call startup to render it
                    cgrid.startup();

                    cgrid.on("RowDblClick", function(evt){
                        var idx = evt.rowIndex,
                            item = this.getItem(idx),
                            store = this.store;
                        var id = store.getValue(item,"contact_id");
                        var name = "{{name}} - " + store.getValue(item,"name");
                        var tab_url = "/manage/dealer/{{dealer_id}}/contact/" + id + "/";
                        var uuid = "{{dealer_id}}" + id;
                        addTab(name,uuid, tab_url);
                    }, true);
                });
            });
        </script>
        <button onclick="dijit.byId('{{dealer_id}}').refresh();">Refresh Tab</button>
        <h1>{{ name }}</h1>
        <br/>
        <div id="dealerChangeButtonContainer{{dealer_id}}"></div>
        <h2>Site List</h2>
        <div id="site_grid{{dealer_id}}"></div>
        <br/>
        <h2>Contact List</h2>
        <div id="contact_grid{{dealer_id}}"></div>
        <br/>

